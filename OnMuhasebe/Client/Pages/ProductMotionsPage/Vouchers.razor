@page "/voucherlist"
@using Newtonsoft.Json
@using OnMuhasebe.Application.CustomExceptions
@using OnMuhasebe.Application.DTOs
@using OnMuhasebe.Application.DTOs.OtherDTOS
@using OnMuhasebe.Application.Json
@using OnMuhasebe.Client.CustomComponents.Grid
@using OnMuhasebe.Client.Utils
@inject DialogService dialogService
@inject NotificationService NotificationService
<RadzenButton Shade="Shade.Dark" Click=goCreateUserPage Icon="add" Variant="Variant.Flat" Text="Yeni Müşteri Ekle" ButtonStyle="ButtonStyle.Success" />
<Grid Columns="Columns" Data="voucherLists" UIWithT="RenderColumn" UIWithT2="RenderColumn" TItem="VoucherDTO" OnDeleteAction="DeleteUser" OnEditAction="goUpdateUserPage" />

@code {
    [Inject]
    public HttpClient Client { get; set; }

    [Inject]
    ModalManager ModalManager { get; set; }

    [Inject]
    NavigationManager NavigationManager { get; set; }
    [Inject]
    ILocalStorageService localStorageService { get; set; }

    public List<ColumnConfig> columnConfigs;
    List<RadzenDataGridColumn<VoucherDTO>> Columns = new List<RadzenDataGridColumn<VoucherDTO>>();
    DynamicGrid<VoucherDTO> gridList = new DynamicGrid<VoucherDTO>();
    protected IEnumerable<VoucherDTO> voucherLists;
    private RenderFragment<RadzenDataGridColumn<VoucherDTO>> RenderColumn = (column) =>@<RadzenDataGridColumn TItem="VoucherDTO" Property="@(column.Property)" Title="@(column.Title)">

    </RadzenDataGridColumn>
    ;
    protected async override Task OnInitializedAsync()
    {
        await LoadList();
    }
    protected async void goCreateUserPage()
    {
        await dialogService.OpenAsync("İşlem Seç", ds =>@<OnMuhasebe.Client.Pages.ProductMotionsPage.ProductMotion />, new DialogOptions() { CloseDialogOnEsc = true, Width = "50%", Height = "60%", ShowClose = true, Resizable = false, AutoFocusFirstElement = true, Draggable = true, ShowTitle = true });
    }

    protected void goUpdateUserPage(Guid UserId)
    {
        NavigationManager.NavigateTo("/vouchers/edit/" + UserId);
    }

    protected async void DeleteUser(Guid Id)
    {
        bool confirmed = await ModalManager.ConfirmationAsync("Confirmation", "Ürünü Silmek İstediğinize eminmisiniz ?");

        if (!confirmed) return;

        try
        {
            string token = await localStorageService.GetItemAsStringAsync("token");
            bool deleted = await Client.PostGetServiceResponseAsync<bool, Guid>("api/voucher/Delete", Id, token, true);

            await LoadList();
        }
        catch (ApiException ex)
        {
            await ModalManager.ShowMessageAsync("voucher Deletion Error", ex.Message);
        }
        catch (Exception ex)
        {
            await ModalManager.ShowMessageAsync("An Error", ex.Message);
        }
    }


    protected async Task LoadList()
    {
        try
        {
            string token = await localStorageService.GetItemAsStringAsync("token");
            voucherLists = await Client.GetServiceResponseAsync<List<VoucherDTO>>("api/voucher/vouchers", token, true);
            columnConfigs = JsonConvert.DeserializeObject<List<ColumnConfig>>(VoucherJson.json);
            gridList.GenerateColumnsFromType(null, columnConfigs);

            foreach (var item in gridList.Columns)
            {
                Columns.Add(item);
            }
        }
        catch (ApiException ex)
        {
            await ModalManager.ShowMessageAsync("Api Exception", ex.Message);
        }
        catch (Exception ex)
        {
            await ModalManager.ShowMessageAsync("Exception", ex.Message);
        }
    }
}
